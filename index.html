<!DOCTYPE html>
<html>
<head>
<title>Dots, Dashes 'n Doods</title>
<style type="text/css">
	html,body {
		margin: 0;
		padding: 0;
	    overflow: hidden;
	    width: 100%;
	    height: 100%;
	}

	/* Scale canvas with resize attribute to full size */
	canvas[resize] {
		padding: 0;
	    width: 100%;
	    height: 100%;
	}
</style>
<script type="text/javascript" src="js/libs/paper-core.js"></script>
<script type="text/javascript">

	window.onload = function() {
		paper.install(window);
		paper.setup('myCanvas');

		debugger;

		var players = [
			{
				id: 0,
				name: 'red',
				color: '#682B1B',
				bases: []
			}
			,{
				id: 1,
				name: 'green',
				color: '#1B682B',
				bases: []
			}
			,{
				id: 2,
				name: 'blue',
				color: '#1B2B68',
				bases: []
			}
		];
		var currentPlayer = players[0];

		var lineLayer = new Layer();
		var dotLayer = new Layer();
		var doodLayer = new Layer();

		var fps = new PointText();
		fps.point = new Point(20,20);
		fps.onFrame = function(event) {
			fps.content = 'FPS: ' + Math.round(1 / event.delta)
		};

		var minDistance = 150;
		var maxDistance = 200;
		var spawn = new Rectangle(
			minDistance / 2,
			minDistance / 2,
			view.bounds.width - minDistance,
			view.bounds.height - minDistance
		);
		var dots = [];
		var pingOnFrame = function(event) {
			this.scale(1 + 1 * event.delta);
			this.strokeColor.alpha -= 1 * event.delta;
			if (this.strokeColor.alpha < 0.01) {
				this.remove();
			}
		};
		var dotOnMouseEnter = function(event) {
			var doPing = (function() {
				var ping = new Path.Circle(this.position.clone(), 20);
				lineLayer.addChild(ping);
				ping.sendToBack();
				ping.strokeColor = new Color(0,0,0,128);
				ping.strokeWidth = 5;
				ping.onFrame = pingOnFrame;
			}).bind(this);
			doPing();
			this.data.pingInterval = setInterval(doPing, 1000);
		};
		var dotOnMouseLeave = function(event) {
			clearInterval(this.data.pingInterval);
			this.data.pingInterval = null;
		};
		var doodArived = function(dood, destination) {
			var distance = 80081355;
			var closest = null;
			for (var p = 0; p < players.length; p++) {
				var player = players[p];
				if (player.id != dood.data.owner.id) {
					for (var d = 0; d < destination.data.doods[player.id].length; d++) {
						var check = destination.data.doods[player.id][d];
						var dist = check.position.getDistance(dood.position);
						if (dist < distance) {
							distance = dist;
							closest = check;
						}
					}
				}
			}
			if (closest === null) {
				dood.data.base = destination;
				destination.data.doods[dood.data.owner.id].push(dood);
				dood.data.connection = null;
			} else {
				var laser = new Path([dood.position,closest.position]);
				laser.strokeColor = new Color(1,0,0,1);
				doodLayer.addChild(laser);
				laser.onFrame = function(event) {
					this.strokeColor.alpha = 1 - event.time * 2;
					if (event.time >= 0.5) {
						this.remove();
					}
				};

				killDood(dood);
				killDood(closest);
			}
		};
		var spotForDood = function(dood, dot) {
			var pos = dot.position.clone();
			pos.x += Math.cos(dood.data.angle) * dood.data.offset;
			pos.y += Math.sin(dood.data.angle) * dood.data.offset;
			return pos;
		};
		var createDood = function(dot, player) {
			var dood = new Path(doodSegments);
			doodLayer.addChild(dood);
			// dot.data.doods[player.id].push(dood);
			dood.data.owner = player;
			// dood.data.base = dot;
			dood.data.offset = 35 + 10 * Math.random();
			dood.data.angle = Math.PI * 2 * Math.random();
			dood.position = spotForDood(dood, dot);

			dood.rotate(360 * Math.random());
			dood.onFrame = doodOnFrame;

			doodArived(dood, dot);
		};
		var dotOnFrame = function(event) {
			if (this.data.owner) {
				this.fillColor = this.data.owner.color;
				if (this.data.doods[this.data.owner.id].length < 20) {
					this.data.spawnTimer += event.delta;
					if (this.data.spawnTimer >= 3) {
						createDood(this, this.data.owner);
						this.data.spawnTimer -= 3;
					}
				}
				this.data.text.content = '^' + this.data.doods[this.data.owner.id].length;
				this.data.text.fillColor = 'white';
			} else {
				var count = 0;
				var most = null;
				for (var p = 0; p < players.length; p++) {
					var player = players[p];
					var c = this.data.doods[player.id].length;
					if (c > count) {
						count = c;
						most = player;
					}
				}
				if (count) {
					this.data.text.content = '^' + count;
					if (count < 10) {
						this.data.text.fillColor = '#FF0000';
					} else {
						this.data.text.fillColor = '#00FF00';
					}
				} else {
					this.data.text.content = '';
				}
			}
		};
		var createDot = function(pos) {
			var dot = new Path.Circle(pos, 25);
			dot.data.doods = {};
			for (var p = 0; p < players.length; p++) {
				dot.data.doods[players[p].id] = [];
			}
			dot.data.connections = [];
			dotLayer.addChild(dot);
			dots.push(dot);
			dot.fillColor = 'black';
			dot.onMouseEnter = dotOnMouseEnter;
			dot.onMouseLeave = dotOnMouseLeave;
			dot.onFrame = dotOnFrame;

			var text = new PointText();
			dot.data.text = text;
			var pos = dot.position.clone();
			pos.y += text.fontSize/3;
			text.point = pos;
			text.justification = 'center';

			return dot;
		};
		// Seed dot for generation
		createDot(new Point(spawn.x + Math.random() * spawn.width, spawn.y + Math.random() * spawn.height));
		// Pick a random dot and try and find a valid place around it
		var sanity = 1000;
		while (sanity > 0) {
			var root = dots[Math.round((dots.length-1) * Math.random())];
			var dist = minDistance + (maxDistance - minDistance) * Math.random();
			var angle = Math.PI*2 * Math.random();
			var pos = null;
			for (var a = 0; a < Math.PI*2; a += Math.PI/2) {
				pos = root.position.clone();
				pos.x += Math.cos(angle+a) * dist;
				pos.y += Math.sin(angle+a) * dist;
				if (spawn.contains(pos)) {
					for (var i = 0; i < dots.length; i++) {
						var dot = dots[i];
						var dist = pos.getDistance(dot.position);
						if (dist < minDistance) {
							pos = null;
							break;
						}
					}
				} else {
					pos = null;
				}
				if (pos !== null) {
					break;
				}
			}
			if (pos !== null) {
				sanity = 1000;
				var dot = createDot(pos);
			} else {
				sanity -= 1;
			}
		}

		var size = 5;
		var doodSegments = [
			new Point(5, 0),
			new Point(Math.cos(Math.PI * 2/3) * 5, Math.sin(Math.PI * 2/3) * 5),
			new Point(Math.cos(Math.PI * 4/3) * 5, Math.sin(Math.PI * 4/3) * 5)
		];

		var doodOnFrame = function(event) {
			if (this.data.owner) {
				this.fillColor = this.data.owner.color;
			} else {
				this.fillColor = 'black';
			}
			var oldPos = this.position.clone();
			if (this.data.connection) {
				var pos = spotForDood(this, this.data.connection.dot);
				pos = pos.subtract(this.position);
				var move = this.data.speed * event.delta;
				if (pos.length <= move) {
					doodArived(this, this.data.connection.dot);
				} else {
					pos.length = move;
					pos = pos.add(this.position);
					this.position = pos;
				}
			}
			if (this.data.base) {
				this.data.angle += (125 - this.data.offset) * Math.PI/180 * event.delta;
				this.position = spotForDood(this, this.data.base);
			}
			this.data.lastDirection = this.position.subtract(oldPos).normalize();
		};
		var closestDot = function(point) {
			var distance = 80081355;
			var closest = null;
			for (var d = 0; d < dots.length; d++) {
				var dot = dots[d];
				var dist = point.getDistance(dot.position);
				if (dist < distance) {
					distance = dist;
					closest = dot;
				}
			}
			return closest;
		};
		var colonize = function(dot, player) {
			if (dot.data.owner) {
				dot.data.owner.bases.splice(dot.data.owner.bases.indexOf(dot), 1);
			}
			dot.data.spawnTimer = 0;
			dot.data.owner = player;
			player.bases.push(dot);
		};
		var radius = Math.max(view.bounds.width,view.bounds.height);
		var angle = 30 * Math.PI/180;
		var deltaAngle = Math.PI*2 / players.length;
		for (var p = 0; p < players.length; p++) {
			var player = players[p];
			var pos = spawn.center.clone();
			pos.x += Math.cos(angle + deltaAngle * p) * radius;
			pos.y += Math.sin(angle + deltaAngle * p) * radius;
			var base = closestDot(pos);
			colonize(base, player);
			while (base.data.doods[player.id].length < 5) {
				createDood(base, player);
			}
		}

		var selected = null;
		var start = null;
		var line = null;

		var tool = new Tool();
		tool.onMouseDown = function(event) {
			for (var i = 0; i < dots.length; i++) {
				var dot = dots[i];
				if (dot.contains(event.point)) {
					start = dot;
					break;
				}
			}
		}

		tool.onMouseDrag = function(event) {
			if (line === null && start !== null) {
				line = new Path();
				lineLayer.addChild(line);

				line.strokeColor = new Color(0,0,0,0.75);
				line.strokeWidth = 20;
				line.add(start.bounds.center);
				line.add(event.point);

				var cost = new PointText();
				lineLayer.addChild(cost);
				line.data.cost = cost;
				cost.content = '^';
				cost.justification = 'center';
			}
			if (line !== null) {
				var startPos = start.position;
				var endPos = event.point;
				for (var i = 0; i < dots.length; i++) {
					var end = dots[i];
					if (end != start && end.contains(event.point)) {
						endPos = end.position;
						break;
					}
				}
				line.segments[1].point = endPos;

				var dist = Math.ceil(line.length / 100);
				line.data.cost.content = '^' + dist;
				if (dist > start.data.doods[currentPlayer.id].length) {
					line.data.cost.fillColor = '#FF0000';
				} else {
					line.data.cost.fillColor = '#00FF00';
				}
				var pos = line.position.clone();
				pos.y += line.data.cost.fontSize/3;
				line.data.cost.point = pos;
			}
		};

		var addConnections = function(start, line, end) {
			start.data.connections.push({
				dot: end,
				line: line
			});
			end.data.connections.push({
				dot: start,
				line: line
			});
		};
		var moveDood = function(start, connection) {
			var dood = start.data.doods[currentPlayer.id].pop();
			dood.data.base = null;
			dood.data.connection = connection;
			dood.data.speed = connection.line.length / 2;
		};
		var killDood = function(dood) {
			if (dood.data.base) {
				dood.data.base.data.doods[dood.data.owner.id].splice(dood.data.base.data.doods[dood.data.owner.id].indexOf(dood),1);
			}
			for (var c = 0; c < 5; c++) {
				var cloud = new Path.Circle(dood.position,5);
				doodLayer.addChild(cloud);
				cloud.fillColor = new Color(0,0,0,0.5);
				var dir = new Point(Math.cos(Math.PI*2*Math.random()),Math.sin(Math.PI*2*Math.random())).normalize();
				dir = dir.add(dood.data.lastDirection);
				cloud.data.dir = dir;
				cloud.onFrame = function(event) {
					var pos = this.position;
					pos.x += this.data.dir.x * 50 * event.delta;
					pos.y += this.data.dir.y * 50 * event.delta;
					this.position = pos;
					this.fillColor.alpha = 0.5 - 0.5 * event.time/0.3;
					if (event.time > 0.3) {
						this.remove(0);
					}
				};
			}

			dood.remove();
		};
		var selOnFrame = function(event) {
			if (Key.isDown('a')) {
				this.strokeColor = '#FF0000';
			} else if (Key.isDown('c')) {
				this.strokeColor = '#00FF00';
			} else {
				this.strokeColor = '#FFFFFF';
			}
			this.strokeColor.alpha = 0.75 + 0.25 * Math.sin(Math.PI*2 * event.time);
		};
		tool.onMouseUp = function(event) {
			if (line !== null) {
				line.data.cost.remove();

				var startPos = start.position;
				for (var i = 0; i < dots.length; i++) {
					var end = dots[i];
					if (end != start && end.contains(event.point)) {
						var dist = Math.ceil(line.length / 100);
						if (dist <= start.data.doods[currentPlayer.id].length) {
							while (dist) {
								var dood = start.data.doods[currentPlayer.id][0];
								killDood(dood);
								dist--;
							}
							line.segments[1].point = end.position;
							line.strokeColor.alpha = 1;
							addConnections(start,line,end);
							line = null;
						}
						break;
					}
				}
				if (line !== null) {
					line.remove();
					line = null;
				}
			} else if (start !== null) {
				if (selected !== null && Key.isDown('a')) {
					if (start !== selected && selected.data.doods[currentPlayer.id].length) {
						for (var i = 0; i < selected.data.connections.length; i++) {
							var connection = selected.data.connections[i];
							if (connection.dot === start) {
								if (Key.isDown('shift')) {
									moveDood(selected, connection);
								} else {
									while (selected.data.doods[currentPlayer.id].length) {
										moveDood(selected, connection);
									}
								}
								break;
							}
						}
					}
				} else if (selected !== null && Key.isDown('c')) {
					if (
						start === selected
						&& (!selected.data.owner || selected.data.owner.id != currentPlayer.id)
						&& selected.data.doods[currentPlayer.id].length >= 10
					) {
						colonize(selected, currentPlayer);
						for (var k = 10; k; k--) {
							killDood(selected.data.doods[currentPlayer.id][0]);
						}
					}
				} else if (start !== selected) {
					if (selected !== null) {
						selected.data.selection.remove();
					}
					selected = start;
					console.log(project.activeLayer);
					console.log(start.layer);
					var sel = new Path.Circle(start.position, 23);
					dotLayer.addChild(sel);
					start.data.selection = sel;
					sel.strokeColor = 'white';
					sel.strokeWidth = 2;
					sel.onFrame = selOnFrame;
				}
			}
			start = null;
		};

		tool.activate();
	};
</script>
</head>
<body>
	<canvas id="myCanvas" resize></canvas>
</body>
</html>