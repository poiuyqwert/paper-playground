<!DOCTYPE html>
<html>
<head>
<title>Dots, Dashes 'n Doods</title>
<style type="text/css">
	html,body {
		margin: 0;
		padding: 0;
	    overflow: hidden;
	    width: 100%;
	    height: 100%;
	}

	/* Scale canvas with resize attribute to full size */
	canvas[resize] {
		padding: 0;
	    width: 100%;
	    height: 100%;
	}
</style>
<script type="text/javascript" src="js/libs/paper-core.js"></script>
<script type="text/javascript">

	window.onload = function() {
		paper.install(window);
		paper.setup('myCanvas');

		debugger;

		var players = [
			{
				name: 'red',
				color: '#682B1B',
				bases: []
			}
			,{
				name: 'green',
				color: '#1B682B',
				bases: []
			}
			,{
				name: 'blue',
				color: '#1B2B68',
				bases: []
			}
		];

		var lineLayer = new Layer();
		var dotLayer = new Layer();
		var doodLayer = new Layer();

		var minDistance = 150;
		var maxDistance = 200;
		var spawn = new Rectangle(
			minDistance / 2,
			minDistance / 2,
			view.bounds.width - minDistance,
			view.bounds.height - minDistance
		);
		var dots = [];
		var pingOnFrame = function(event) {
			this.scale(1 + 1 * event.delta);
			this.strokeColor.alpha -= 1 * event.delta;
			if (this.strokeColor.alpha < 0.01) {
				this.remove();
			}
		};
		var dotOnMouseEnter = function(event) {
			var doPing = (function() {
				var ping = new Path.Circle(this.position.clone(), 20);
				lineLayer.addChild(ping);
				ping.sendToBack();
				ping.strokeColor = new Color(0,0,0,128);
				ping.strokeWidth = 5;
				ping.onFrame = pingOnFrame;
			}).bind(this);
			doPing();
			this.data.pingInterval = setInterval(doPing, 1000);
		};
		var dotOnMouseLeave = function(event) {
			clearInterval(this.data.pingInterval);
			this.data.pingInterval = null;
		};
		var dotOnFrame = function(event) {
			if (this.data.owner) {
				this.fillColor = this.data.owner.color;
			}
		};
		var createDot = function(pos) {
			var dot = new Path.Circle(pos, 25);
			dot.data.doods = [];
			dot.data.connections = [];
			dotLayer.addChild(dot);
			dots.push(dot);
			dot.fillColor = 'black';
			dot.onMouseEnter = dotOnMouseEnter;
			dot.onMouseLeave = dotOnMouseLeave;
			dot.onFrame = dotOnFrame;
			return dot;
		};
		// Seed dot for generation
		createDot(new Point(spawn.x + Math.random() * spawn.width, spawn.y + Math.random() * spawn.height));
		// Pick a random dot and try and find a valid place around it
		var sanity = 1000;
		while (dots.length < 15 && sanity > 0) {
			var root = dots[Math.round((dots.length-1) * Math.random())];
			var dist = minDistance + (maxDistance - minDistance) * Math.random();
			var angle = Math.PI*2 * Math.random();
			var pos = null;
			for (var a = 0; a < Math.PI*2; a += Math.PI/2) {
				pos = root.position.clone();
				pos.x += Math.cos(angle+a) * dist;
				pos.y += Math.sin(angle+a) * dist;
				if (spawn.contains(pos)) {
					for (var i = 0; i < dots.length; i++) {
						var dot = dots[i];
						var dist = pos.getDistance(dot.position);
						if (dist < minDistance) {
							pos = null;
							break;
						}
					}
				} else {
					pos = null;
				}
				if (pos !== null) {
					break;
				}
			}
			if (pos !== null) {
				sanity = 1000;
				var dot = createDot(pos);
			} else {
				sanity -= 1;
			}
		}

		var size = 5;
		var segments = [
			new Point(5, 0),
			new Point(Math.cos(Math.PI * 2/3) * 5, Math.sin(Math.PI * 2/3) * 5),
			new Point(Math.cos(Math.PI * 4/3) * 5, Math.sin(Math.PI * 4/3) * 5)
		];

		var spotForDood = function(dood, dot) {
			var pos = dot.position.clone();
			pos.x += Math.cos(dood.data.angle) * dood.data.offset;
			pos.y += Math.sin(dood.data.angle) * dood.data.offset;
			return pos;
		};
		var doodOnFrame = function(event) {
			if (this.data.owner) {
				this.fillColor = this.data.owner.color;
			} else {
				this.fillColor = 'black';
			}
			if (this.data.connection) {
				var pos = spotForDood(this, this.data.connection.dot);
				pos = pos.subtract(this.position);
				var move = this.data.speed * event.delta;
				if (pos.length <= move) {
					this.data.base = this.data.connection.dot;
					this.data.base.data.doods.push(this);
					this.data.connection = null;
				} else {
					pos.length = move;
					pos = pos.add(this.position);
					this.position = pos;
				}
			}
			if (this.data.base) {
				this.data.angle += (125 - this.data.offset) * Math.PI/180 * event.delta;
				this.position = spotForDood(this, this.data.base);
			}
		};
		var closestDot = function(point) {
			var distance = 80081355;
			var closest = null;
			for (var d = 0; d < dots.length; d++) {
				var dot = dots[d];
				var dist = point.getDistance(dot.position);
				if (dist < distance) {
					distance = dist;
					closest = dot;
				}
			}
			return closest;
		};
		var radius = Math.max(view.bounds.width,view.bounds.height);
		var angle = Math.PI/4;
		var deltaAngle = Math.PI*2 / players.length;
		for (var p = 0; p < players.length; p++) {
			var player = players[p];
			var pos = spawn.center.clone();
			pos.x += Math.cos(angle + deltaAngle * p) * radius;
			pos.y += Math.sin(angle + deltaAngle * p) * radius;
			player.base = closestDot(pos);
			player.base.data.owner = player;
			while (player.base.data.doods.length < 5) {
				var dood = new Path(segments);
				doodLayer.addChild(dood);
				player.base.data.doods.push(dood);
				dood.data.owner = player;
				dood.data.base = player.base;
				dood.data.offset = 35 + 10 * Math.random();
				dood.data.angle = Math.PI * 2 * Math.random();

				dood.rotate(360 * Math.random());
				dood.onFrame = doodOnFrame;
			}
		}

		var selected = null;
		var start = null;
		var line = null;

		var tool = new Tool();
		tool.onMouseDown = function(event) {
			for (var i = 0; i < dots.length; i++) {
				var dot = dots[i];
				if (dot.contains(event.point)) {
					start = dot;
					break;
				}
			}
		}

		tool.onMouseDrag = function(event) {
			if (line === null && start !== null) {
				line = new Path();
				lineLayer.addChild(line);
				line.strokeColor = new Color(0,0,0,0.75);
				line.strokeWidth = 20;
				line.add(start.bounds.center);
				line.add(event.point);

				var cost = new PointText();
				lineLayer.addChild(cost);
				line.data.cost = cost;
				cost.content = '^';
				cost.justification = 'center';
			}
			if (line !== null) {
				var startPos = start.position;
				var endPos = event.point;
				for (var i = 0; i < dots.length; i++) {
					var end = dots[i];
					if (end != start && end.contains(event.point)) {
						endPos = end.position;
						break;
					}
				}
				line.segments[1].point = endPos;

				var dist = Math.round(line.length);
				line.data.cost.content = '^' + dist;
				if (dist > maxDistance) {
					line.data.cost.fillColor = '#FF0000';
				} else {
					line.data.cost.fillColor = '#00FF00';
				}
				var pos = line.position.clone();
				pos.y += line.data.cost.fontSize/3;
				line.data.cost.point = pos;
			}
		};

		var addConnections = function(start, line, end) {
			start.data.connections.push({
				dot: end,
				line: line
			});
			end.data.connections.push({
				dot: start,
				line: line
			});
		};
		var moveDood = function(start, connection) {
			var dood = start.data.doods.pop();
			dood.data.base = null;
			dood.data.connection = connection;
			dood.data.speed = connection.line.length / 2;
		};
		var selOnFrame = function(event) {
			this.strokeColor.alpha = 0.75 + 0.25 * Math.sin(Math.PI*2 * event.time);
			if (Key.isDown('a')) {
				this.strokeColor.green = 0;
				this.strokeColor.blue = 0;
			} else {
				this.strokeColor.green = 1;
				this.strokeColor.blue = 1;
			}
		};
		tool.onMouseUp = function(event) {
			if (line !== null) {
				line.data.cost.remove();

				var startPos = start.position;
				for (var i = 0; i < dots.length; i++) {
					var end = dots[i];
					if (end != start && end.contains(event.point) && startPos.getDistance(end.position) <= maxDistance) {
						line.segments[1].point = end.position;
						line.strokeColor.alpha = 1;
						addConnections(start,line,end);
						line = null;
						break;
					}
				}
				if (line !== null) {
					line.remove();
					line = null;
				}
			} else if (start !== null && start !== selected) {
				if (selected !== null && Key.isDown('a')) {
					if (selected.data.doods.length) {
						for (var i = 0; i < selected.data.connections.length; i++) {
							var connection = selected.data.connections[i];
							if (connection.dot === start) {
								moveDood(selected, connection);
								break;
							}
						}
					}
				} else {
					if (selected !== null) {
						selected.data.selection.remove();
					}
					selected = start;
					console.log(project.activeLayer);
					console.log(start.layer);
					var sel = new Path.Circle(start.position, 23);
					dotLayer.addChild(sel);
					start.data.selection = sel;
					sel.strokeColor = 'white';
					sel.strokeWidth = 2;
					sel.onFrame = selOnFrame;
				}
			}
			start = null;
		};

		tool.activate();
	};
</script>
</head>
<body>
	<canvas id="myCanvas" resize></canvas>
</body>
</html>